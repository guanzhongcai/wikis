# 性能测试



## 平均值不靠谱

最为正确的统计做法是用百分比分布统计。也就是英文中的**TP – Top Percentile** ，TP50的意思在，50%的请求都小于某个值，TP90表示90%的请求小于某个时间。



## 响应时间（latency）要和吞吐量（Thoughput）挂钩

系统的性能如果只看吞吐量，不看响应时间是没有意义的。我的系统可以顶10万请求，但是响应时间已经到了5秒钟，这样的系统已经不可用了，这样的吞吐量也是没有意义的。

**吞吐量的值必需有响应时间来卡。**比如：**TP99小于100ms的时候，系统可以承载的最大并发数是1000qps**。这意味着，我们要不断的在不同的并发数上测试，以找到软件的最稳定时的最大吞吐量。



#### 响应时间吞吐量和成功率要挂钩

性能测试的失败率的容忍应该是非常低的。对于一些关键系统，成功请求数必须在100%，一点都不能含糊。



## 如何严谨地做性能测试

一般来说，性能测试要统一考虑这么几个因素：**Thoughput吞吐量**，**Latency响应时间**，**资源利用**（CPU/MEM/IO/Bandwidth…），**成功率**，**系统稳定性**。

下面的这些性能测试的方式基本上来源自陈皓的老老东家汤森路透，一家做real-time的金融数据系统的公司。

**一，你得定义一个系统的响应时间latency，建议是TP99，以及成功率**。比如路透的定义：99.9%的响应时间必需在1ms之内，平均响应时间在1ms以内，100%的请求成功。

**二，在这个响应时间的限制下，找到最高的吞吐量**。测试用的数据，需要有大中小各种尺寸的数据，并可以混合。最好使用生产线上的测试数据。

**三，在这个吞吐量做Soak Test，比如：使用第二步测试得到的吞吐量连续7天的不间断的压测系统。**然后收集CPU，内存，硬盘/网络IO，等指标，查看系统是否稳定，比如，CPU是平稳的，内存使用也是平稳的。那么，这个值就是系统的性能

**四，找到系统的极限值。比如：在成功率100%的情况下（不考虑响应时间的长短），系统能坚持10分钟的吞吐量。**

**五，做Burst Test。用第二步得到的吞吐量执行5分钟，然后在第四步得到的极限值执行1分钟，再回到第二步的吞吐量执行5钟，再到第四步的权限值执行1分钟，如此往复个一段时间，比如2天。**收集系统数据：CPU、内存、硬盘/网络IO等，观察他们的曲线，以及相应的响应时间，确保系统是稳定的。

**六、低吞吐量和网络小包的测试。**有时候，在低吞吐量的时候，可能会导致latency上升，比如TCP_NODELAY的参数没有开启会导致latency上升（详见[TCP的那些事](https://coolshell.cn/articles/11564.html)），而网络小包会导致带宽用不满也会导致性能上不去，所以，性能测试还需要根据实际情况有选择的测试一下这两咱场景。

（注：在路透，路透会用第二步得到的吞吐量乘以66.7%来做为系统的软报警线，80%做为系统的硬报警线，而极限值仅仅用来扛突发的peak）

**是不是很繁锁？是的，只因为，这是工程，工程是一门科学，科学是严谨的。**



## 参考资料

- [性能测试应该怎么做？](https://coolshell.cn/articles/17381.html)