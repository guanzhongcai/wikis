# kubernates

**Kubernetesåè°ƒè¿æ¥åœ¨ä¸€èµ·ä½œä¸ºä¸€ä¸ªå•å…ƒå·¥ä½œçš„é«˜å¯ç”¨æ€§è®¡ç®—æœºé›†ç¾¤ã€‚**Kubernetesä¸­çš„æŠ½è±¡å…è®¸æ‚¨å°†å®¹å™¨åŒ–çš„åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°é›†ç¾¤ï¼Œè€Œæ— éœ€å°†å®ƒä»¬ä¸“é—¨ç»‘å®šåˆ°å•ä¸ªæœºå™¨ã€‚

![k8s-framework1](../devops/pictures/k8s-framework1.png)

k8sï¼ˆkå’Œsä¸­é—´æœ‰8ä¸ªå­—æ¯ï¼‰æºè‡ªäºGoogleçš„borgèµ„æºç®¡ç†å™¨ï¼Œ10å¹´+å®¹å™¨åŒ–åŸºç¡€æ¶æ„ã€‚åä½¿ç”¨golangå®ç°çš„è¶…å¤§è§„æ¨¡åˆ†å¸ƒå¼éƒ¨ç½²çš„è§£å†³æ–¹æ¡ˆã€‚

dockerçš„æ ‡å‡†æ˜¯é²¸é±¼ğŸ³ï¼Œk8sçš„å›¾æ ‡æ˜¯èˆ¹èˆµï¼Œè¡¨ç¤ºæ–¹å‘ç›˜é¢†èˆªçš„æ„æ€ã€‚

[è°·æ­Œçš„å®¹å™¨ä¹‹è·¯ï¼šä» Borg åˆ° Kubernetes](https://www.infoq.cn/article/2015/05/Kubernetes-Borg-Eurosys)

> Borg æ˜¯è°·æ­Œå…¬å¸çš„å†…éƒ¨å®¹å™¨ç®¡ç†ç³»ç»Ÿã€‚æ—©åœ¨åå‡ å¹´å‰ï¼Œè¯¥å…¬å¸å°±å·²ç»éƒ¨ç½² Borg ç³»ç»Ÿå¯¹æ¥è‡ªäºå‡ åƒä¸ªåº”ç”¨ç¨‹åºæ‰€æäº¤çš„ job è¿›è¡Œæ¥æ”¶ã€è°ƒè¯•ã€å¯åŠ¨ã€åœæ­¢ã€é‡å¯å’Œç›‘æ§ã€‚è¯¥é¡¹ç›®çš„ç›®çš„æ˜¯å®ç°èµ„æºç®¡ç†çš„è‡ªåŠ¨åŒ–ä»¥åŠè·¨å¤šä¸ªæ•°æ®ä¸­å¿ƒçš„èµ„æºåˆ©ç”¨ç‡æœ€å¤§åŒ–ã€‚......



**IPVSï¼š**

IPè™šæ‹ŸæœåŠ¡å™¨ï¼ˆIP Virtual Serverï¼‰ï¼ŒåŸºæœ¬ä¸Šæ˜¯ä¸€ç§é«˜æ•ˆçš„layer-4äº¤æ¢æœºï¼æ˜¯è¿è¡Œåœ¨LVSä¸‹çš„æä¾›è´Ÿè½½å¹³è¡¡åŠŸèƒ½çš„ä¸€ç§æŠ€æœ¯ã€‚ï¼ˆfrom ç« æ–‡åµ©åšå£«ï¼‰[reference](https://baike.baidu.com/item/ipvs/5041817?fr=aladdin)

> å½“ä¸€ä¸ªTCPè¿æ¥çš„åˆå§‹SYNæŠ¥æ–‡åˆ°è¾¾æ—¶ï¼ŒIPVSå°±é€‰æ‹©ä¸€å°æœåŠ¡å™¨ï¼Œå°†æŠ¥æ–‡è½¬å‘ç»™å®ƒã€‚æ­¤åé€šè¿‡æŸ¥å‘æŠ¥æ–‡çš„IPå’ŒTCPæŠ¥æ–‡å¤´åœ°å€ï¼Œä¿è¯æ­¤è¿æ¥çš„åç»§æŠ¥æ–‡è¢«è½¬å‘åˆ°ç›¸åŒçš„æœåŠ¡å™¨ã€‚è¿™æ ·ï¼ŒIPVSä¸ç”¨æ£€æŸ¥åˆ°è¯·æ±‚çš„å†…å®¹å†é€‰æ‹©æœåŠ¡å™¨ï¼Œè¿™å°±è¦æ±‚åç«¯çš„æœåŠ¡å™¨ç»„æ˜¯æä¾›ç›¸åŒçš„æœåŠ¡ï¼Œä¸ç®¡è¯·æ±‚è¢«é€åˆ°å“ªä¸€å°æœåŠ¡å™¨ï¼Œè¿”å›ç»“æœéƒ½åº”è¯¥æ˜¯ä¸€æ ·çš„ã€‚ä½†æ˜¯åœ¨æœ‰ä¸€äº›åº”ç”¨ä¸­åç«¯çš„æœåŠ¡å™¨å¯èƒ½åŠŸèƒ½ä¸ä¸€ï¼Œæœ‰çš„æ˜¯æä¾›HTMLæ–‡æ¡£çš„WebæœåŠ¡å™¨ï¼Œæœ‰çš„æ˜¯æä¾›å›¾ç‰‡çš„WebæœåŠ¡å™¨ï¼Œæœ‰çš„æ˜¯æä¾›CGIçš„WebæœåŠ¡å™¨ã€‚è¿™æ—¶ï¼Œå°±éœ€è¦åŸºäºå†…å®¹è¯·æ±‚åˆ†å‘ (Content-Based Request Distribution)ï¼ŒåŒæ—¶åŸºäºå†…å®¹è¯·æ±‚åˆ†å‘å¯ä»¥æé«˜åç«¯æœåŠ¡å™¨ä¸Šè®¿é—®çš„å±€éƒ¨æ€§ã€‚



**å’Œapacheçš„mesosæ¯”è¾ƒ**

ä¹Ÿæ˜¯åˆ†å¸ƒå¼èµ„æºç®¡ç†æ¡†æ¶ï¼ŒTwitterä¹‹å‰ä½¿ç”¨çš„ï¼Œ2019å¹´ä¹Ÿæ”¾å¼ƒmesosï¼Œè½¬å‘k8s



**å’Œdocker swarmæ¯”è¾ƒ**

æ˜¯dockeråŸå‚å‡ºå“ï¼Œå¾ˆè½»é‡ï¼Œæœ¬æœºåªæ¶ˆè€—å‡ åMBã€‚ä½†åŠŸèƒ½ç›¸å¯¹äºk8så¤ªå°‘ï¼Œæ¯”å¦‚ï¼šæ»šåŠ¨æ›´æ–°ã€å›æ»šç­‰æ“ä½œï¼Œswarmæ‰‹åŠ¨å®ç°èµ·æ¥å¾ˆå¤æ‚ã€‚ä¹Ÿèƒ½å¤§è§„æ¨¡åŒ–ï¼Œä½†å®ç°èµ·æ¥è¿˜æ˜¯å¤ªè´¹äº‹ã€‚

é˜¿é‡Œäº‘ä¹Ÿåœ¨2019å¹´å–æ¶ˆswarmï¼Œåªæ”¯æŒk8sã€‚



## ç‰¹ç‚¹

- è½»é‡çº§ï¼šæ¶ˆè€—èµ„æºå°‘
- å¼€æº
- å¼¹æ€§ä¼¸ç¼©ï¼šå¯å¤§å¯å°
- è´Ÿè½½å‡è¡¡ï¼šIPVS



**borgæ¡†æ¶ï¼š**

![borg-framework](./pictures/borg-framework.png)



**k8sæ¡†æ¶ï¼š**

![k8s-framework](./pictures/k8s-framework.png)



**é«˜å¯ç”¨é›†ç¾¤å‰¯æœ¬æ•°æ®æœ€å¥½æ˜¯å¤§äºç­‰äº3çš„å¥‡æ•°ä¸ªï¼**

### masterç»„ä»¶

**ä¸»æœºè´Ÿè´£ç®¡ç†ç¾¤é›†ã€‚**ä¸»æœåŠ¡å™¨åè°ƒé›†ç¾¤ä¸­çš„æ‰€æœ‰æ´»åŠ¨ï¼Œä¾‹å¦‚è°ƒåº¦åº”ç”¨ç¨‹åºï¼Œç»´æŠ¤åº”ç”¨ç¨‹åºçš„æ‰€éœ€çŠ¶æ€ï¼Œæ‰©å±•åº”ç”¨ç¨‹åºä»¥åŠæ¨å‡ºæ–°çš„æ›´æ–°ã€‚

- api serverï¼š æ‰€æœ‰æœåŠ¡è®¿é—®çš„ç»Ÿä¸€å…¥å£
- Replication controllerï¼šç»´æŒå‰¯æœ¬æœŸæœ›æ•°ç›®
- Schedulerï¼šè´Ÿè´£æ¥æ”¶ä»»åŠ¡ï¼Œé€‰æ‹©åˆé€‚çš„èŠ‚ç‚¹è¿›è¡Œåˆ†é…ä»»åŠ¡
- etcdï¼šé”®å€¼å¯¹æ•°æ®åº“ï¼Œå‚¨å­˜k8sé›†ç¾¤æ‰€æœ‰é‡è¦ä¿¡æ¯ï¼ˆæŒä¹…åŒ–ï¼‰

```shell
minikube start --docker-env HTTP_PROXY=http://localhost:5710 --docker-env HTTPS_PROXY=http://localhost:15710 --vm-driver=xhyve
```

### nodeç»„ä»¶

èŠ‚ç‚¹æ˜¯ä½œä¸ºKubernetesé›†ç¾¤ä¸­çš„å·¥ä½œæœºçš„è™šæ‹Ÿæœºæˆ–ç‰©ç†è®¡ç®—æœºã€‚æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªKubeletï¼Œå®ƒæ˜¯ç®¡ç†èŠ‚ç‚¹å’Œä¸Kubernetesä¸»æœºé€šä¿¡çš„ä»£ç†ã€‚

- kubeletï¼šç›´æ¥è·Ÿå®¹å™¨å¼•æ“äº¤äº’ï¼Œå®ç°å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚

- kube proxyï¼šè´Ÿè´£å†™å…¥è§„åˆ™å€¼IPtablesã€IPVSï¼Œå®ç°æœåŠ¡æ˜ å°„è®¿é—®çš„ã€‚



### å…¶ä»–æ’ä»¶

- CoreDNSï¼šå¯ä»¥ä¸ºé›†ç¾¤ä¸­çš„SVCåˆ›å»ºä¸€ä¸ªåŸŸåæ˜ å°„IPçš„å¯¹åº”å…³ç³»è§£æ
- Dashboardï¼šç»™k8sé›†ç¾¤æä¾›çš„BSç»“æ„çš„è®¿é—®webç•Œé¢
- Ingress Controller: å®˜æ–¹k8så®ç°äº†4å±‚ä»£ç†ï¼ŒIngresså¯ä»¥å®ç°ä¸ƒå±‚ä»£ç†ï¼ˆå³ä¸»æœºåå’ŒåŸŸåçš„ä»£ç†ï¼‰
- Federation: æä¾›ä¸€ä¸ªå¯ä»¥è·¨é›†ç¾¤ä¸­å¿ƒã€å¤šk8sçš„ç»Ÿä¸€ç®¡ç†çš„åŠŸèƒ½
- Prometheus: tsdbï¼Œæä¾›k8sé›†ç¾¤çš„ç›‘æ§èƒ½åŠ›
- ELKï¼šæä¾›k8sé›†ç¾¤æ—¥å¿—ç»Ÿä¸€åˆ†æä»‹å…¥å¹³å°



**ETCDç‰ˆæœ¬é€‰æ‹©ï¼š**

![etcd-select-v3](./pictures/etcd-select-v3.png)

ETCDçš„V2ç‰ˆæœ¬æ•°æ®éƒ½åœ¨å†…å­˜ä¸­ï¼ŒV3ç‰ˆæœ¬å¼•å…¥äº†æœ¬åœ°çš„å·çš„æŒä¹…åŒ–æ“ä½œï¼Œä¿è¯äº†æ•°æ®ä¸ä¼šä¸¢å¤±ï¼Œæ‰€ä»¥å»ºè®®ä½¿ç”¨v3ç‰ˆæœ¬etcdã€‚



![etcd-framework](./pictures/etcd-framework.png)



## WAL

> ä¸ºäº†ä¿æŒå­˜å‚¨ç³»ç»Ÿå†…å­˜ä¸­å…ƒæ•°æ®å’Œç‰©ç†æ•°æ®é—´çš„çŠ¶æ€ä¸€è‡´æ€§ï¼Œç³»ç»Ÿæ‰€æœ‰çš„æ•°æ®æ“ä½œå¯¹åº”çš„å…ƒæ•°æ®å˜æ›´éƒ½éœ€è¦æŒä¹…åŒ–åˆ°å…ƒæ•°æ®dbå†…ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªæ€§èƒ½é—®é¢˜ï¼Œæ¯æ¬¡å˜æ›´å¦‚æœéƒ½è¦å®æ—¶åŒæ­¥åˆ°å¤–éƒ¨dbå†…ï¼Œæ˜¯å¦æ„å‘³ç€é«˜é¢‘çš„ioæ“ä½œï¼Ÿæ˜¯å¦æœ‰å»¶æ—¶å†™å…¥çš„æ‰‹æ®µå‘¢ï¼Ÿ

Write Ahead Logï¼Œåœ¨**åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿ**ä¸­çš„**å…ƒæ•°æ®æ›´æ–°**ä¸­åº”ç”¨å¾—ååˆ†å¹¿æ³›ã€‚WALçš„ä¸»è¦æ„æ€æ˜¯è¯´åœ¨å°†å…ƒæ•°æ®çš„å˜æ›´æ“ä½œå†™å…¥åˆ°æŒä¹…ç¨³å®šçš„dbä¹‹å‰ï¼Œ**å…ˆé¢„å…ˆå†™å…¥åˆ°ä¸€ä¸ªlogä¸­**ï¼Œç„¶åå†ç”±å¦å¤–çš„æ“ä½œå°†log applyåˆ°**å¤–éƒ¨çš„æŒä¹…db**é‡Œå»ã€‚è¿™ç§æ¨¡å¼ä¼šå‡å°‘æ‰æ¯æ¬¡çš„dbå†™å…¥æ“ä½œï¼Œå°¤å…¶å½“ç³»ç»Ÿè¦å¤„ç†å¤§é‡çš„transactionæ“ä½œçš„æ—¶å€™ï¼ŒWALçš„æ–¹å¼ç›¸æ¯”è¾ƒäºå®æ—¶åŒæ­¥dbçš„æ–¹å¼æœ‰ç€æ›´é«˜çš„æ•ˆç‡ã€‚

WALè¿˜æœ‰ä¸€ç‚¹å¾ˆé‡è¦çš„å¸®åŠ©æ˜¯å¯ä»¥åœ¨disaster recoveryè¿‡ç¨‹ä¸­èµ·åˆ°**çŠ¶æ€æ¢å¤**çš„ä½œç”¨ï¼Œç³»ç»Ÿåœ¨loadå®Œå…ƒæ•°æ®dbåï¼Œå†æŠŠæœªæ¥å¾—åŠæäº¤çš„WAL applyè¿›æ¥ï¼Œå°±èƒ½æ¢å¤æˆå’Œä¹‹å‰æœ€ç»ˆä¸€è‡´çš„çŠ¶æ€ã€‚



> å®è·µæ“ä½œï¼follow the tutorialï¼



## minikube

- [å®‰è£…minikube](https://www.cnblogs.com/mengyucloud/p/12244168.html)

```bash
# Mac download & install
curl -Lo minikube https://github.com/kubernetes/minikube/releases/download/v1.6.2/minikube-darwin-amd64 && chmod +x minikube && sudo mv minikube /usr/local/bin/

# å®‰è£…minikubeç¼ºçœæ”¯æŒçš„Kubernetesç‰ˆæœ¬
minikube start --image-mirror-country cn \
    --iso-url=https://kubernetes.oss-cn-hangzhou.aliyuncs.com/minikube/iso/minikube-v1.6.0.iso \
    --registry-mirror=https://xxxxxx.mirror.aliyuncs.com

```



## Podæ§åˆ¶å™¨

Podæ§åˆ¶å™¨æ˜¯k8sçš„çµé­‚ï¼è‡ªä¸»å¼Podã€æ§åˆ¶å™¨ç®¡ç†Podï¼Œç±»å‹æœ‰ï¼š

- åŒä¸€ä¸ªpodä¸­çš„å®¹å™¨å…±äº«ç½‘ç»œï¼šå¯ä»¥ç›¸äº’ä»¥localhostè®¿é—®ï¼Œç«¯å£ä¸å¯é‡å¤

- åŒä¸€ä¸ªpodä¸­å…±äº«å­˜å‚¨å·

  

#### ReplicationController å’ŒReplicaSet

**è´Ÿè´£podåˆ›å»ºå’Œé”€æ¯**ã€‚ç”¨æ¥ç¡®ä¿å®¹å™¨åº”ç”¨çš„å‰¯æœ¬æ•°å§‹ç»ˆä¿æŒåœ¨ç”¨æˆ·å®šä¹‰çš„å‰¯æœ¬æ•°ï¼Œå³å¦‚æœæœ‰å®¹å™¨å¼‚å¸¸é€€å‡ºï¼Œä¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„Podæ›¿ä»£ã€‚å¦‚æœå¤šå‡ºæ¥ï¼Œä¹Ÿä¼šè‡ªåŠ¨å›æ”¶ã€‚**æ–°ç‰ˆæœ¬ä¸­åè€…æ˜¯å–ä»£å‰è€…çš„ï¼Œåè€…ä¹Ÿæ˜¯å¤§å‹é¡¹ç›®ä¸­ä½¿ç”¨**ã€‚



#### Deployment

è‡ªåŠ¨ç®¡ç†ReplicaSetã€‚Deploymentæ¯”RCå’ŒRSå¤šäº†æ”¯æŒrolling-updateï¼ˆæ»šåŠ¨æ›´æ–°ï¼‰ã€‚ä½†Deploymentä¸è´Ÿè´£podåˆ›å»º

> è‹¥è¦æ›´æ–°V2ç‰ˆæœ¬ï¼ŒDeploymentä¼šåˆ›å»ºå¦ä¸€ä¸ªRS2ï¼ŒRS2è´Ÿè´£äº§ç”ŸV2ç‰ˆæœ¬çš„å®¹å™¨ï¼Œæ­¤æ—¶V1çš„RS1ä¼šé€æ­¥åœæ­¢ï¼Œä½†ä¸ä¼šåˆ é™¤ï¼Œä¸ºå›æ»šå‡†å¤‡ã€‚



#### DaemonSet

DaemonSetç¡®ä¿å…¨éƒ¨Nodeä¸Šè¿è¡Œä¸€ä¸ªPodçš„å‰¯æœ¬ã€‚å½“æœ‰NodeåŠ å…¥é›†ç¾¤æ—¶ï¼Œä¹Ÿä¼šä¸ºä»–ä»¬æ–°å¢ä¸€ä¸ªPodã€‚å½“æœ‰Nodeä»é›†ç¾¤ç§»é™¤æ—¶ï¼Œè¿™äº›Podä¹Ÿä¼šè¢«å›æ”¶ã€‚åˆ é™¤DaemonSetå°†ä¼šåˆ é™¤å®ƒåˆ›å»ºçš„æ‰€æœ‰Podã€‚å…¸å‹ç”¨æ³•æœ‰ï¼š

- è¿è¡Œé›†ç¾¤éƒ¨ç½²daemonï¼Œä¾‹å¦‚åœ¨æ¯ä¸ªNodeä¸Šè¿è¡Œglusterdã€cephã€‚ï¼Ÿï¼Ÿï¼Ÿ
- åœ¨æ¯ä¸ªNodeä¸Šè¿è¡Œæ—¥å¿—æ”¶é›†daemonï¼Œä¾‹å¦‚fluentdã€logstash
- åœ¨æ¯ä¸ªNodeä¸Šè¿è¡Œç›‘æ§daemonï¼Œä¾‹å¦‚Prometheus Node Exporter

å½“éœ€è¦è¿è¡Œå¥½å‡ ä¸ªä¸åŒdaemonçš„æ—¶å€™ï¼Œå¯ä»¥æŠŠä»–ä»¬æ”¾å…¥ä¸€ä¸ªpodæ¥è¿è¡Œã€‚



#### Job

è´Ÿè´£æ‰§è¡Œæ‰¹å¤„ç†ä»»åŠ¡ï¼Œä»…æ‰§è¡Œä¸€æ¬¡ã€‚å®ƒä¿è¯æ‰¹å¤„ç†ä»»åŠ¡çš„ä¸€ä¸ªæˆ–å¤šä¸ªPodæˆåŠŸç»“æŸã€‚



#### CronJob

åŒlinuxçš„crobã€‚



#### StatefulSet

ä¸ºäº†è§£å†³æœ‰çŠ¶æ€æœåŠ¡çš„é—®é¢˜ã€‚ï¼ˆDeploymentå’ŒReplicaSetä¸ºæ— çŠ¶æ€æœåŠ¡è€Œè®¾è®¡ï¼‰ï¼Œåº”ç”¨åœºæ™¯åŒ…æ‹¬ï¼š

- ç¨³å®šçš„æŒä¹…åŒ–å­˜å‚¨ï¼šå³Podé‡æ–°è°ƒåº¦åï¼Œè¿˜æ˜¯èƒ½è®¿é—®åˆ°ç›¸åŒçš„æŒä¹…åŒ–æ•°æ®ï¼ŒåŸºäºPVCå®ç°
- ç¨³å®šçš„ç½‘ç»œæ ‡å¿—ï¼šå³Podé‡æ–°è°ƒåº¦åæœŸPodNameå’ŒHostNameä¸å˜ï¼ŒåŸºäºHeadless Serviceï¼ˆå³æ²¡æœ‰Cluster IPçš„Serviceï¼‰æ¥å®ç°
- æœ‰åºéƒ¨ç½²ï¼Œæœ‰åºæ‰©å±•ï¼šå³Podæ˜¯æœ‰é¡ºåºçš„ï¼Œåœ¨éƒ¨ç½²æˆ–è€…æ‰©å±•çš„æ—¶å€™ï¼Œè¦ä¾æ®å®šä¹‰çš„é¡ºåºä¾æ¬¡è¿›è¡Œï¼ˆå³ä»0åˆ°N-1ï¼Œåœ¨ä¸‹ä¸€ä¸ªPodè¿è¡Œä¹‹å‰æ‰€æœ‰ä¹‹å‰çš„Podå¿…é¡»éƒ½æ˜¯Running å’ŒReadyçŠ¶æ€ï¼‰ï¼ŒåŸºäºinit containersæ¥å®ç°ã€‚
- æœ‰åºæ”¶ç¼©ï¼Œæœ‰åºåˆ é™¤ï¼šå³ä»N-1åˆ°0



#### Horizontal Pod Autoscalingï¼šHPAï¼Œ

å¹³æ»‘æ‰©ç¼©å®¹ï¼Œæ ¹æ®Podçš„CPUåˆ©ç”¨ç‡ï¼ˆv1ç‰ˆæœ¬ï¼‰ï¼ˆv1 alphaç‰ˆæœ¬ä¸­å¯ä»¥æ ¹æ®å†…å­˜å’Œç”¨æˆ·è‡ªå®šä¹‰metricï¼‰

>  if CPU > 80 then Max=10, Min=2



## ç½‘ç»œé€šè®¯æ¨¡å¼

k8sçš„ç½‘ç»œæ¨¡å‹å‡å®šäº†æ‰€æœ‰Podéƒ½åœ¨ä¸€ä¸ªäº’ç›¸è¿é€šï¼ˆé€šè¿‡IPï¼‰çš„æ‰å¹³åŒ–ç½‘ç»œç©ºé—´ä¸­ã€‚è¿™åœ¨GCEï¼ˆGoogle Compute Engineï¼‰é‡Œé¢æ˜¯çº¿ç¨‹çš„ç½‘ç»œæ¨¡å‹ï¼Œk8så‡å®šè¿™ä¸ªç½‘ç»œå·²ç»å­˜åœ¨ã€‚

åœ¨ç§æœ‰äº‘é‡Œæ­å»ºk8sé›†ç¾¤ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±å®ç°ç½‘ç»œäº’é€šï¼Œå°†ä¸åŒèŠ‚ç‚¹ä¸Šçš„dockerå®¹å™¨ä¹‹é—´çš„äº’ç›¸è®¿é—®å…ˆæ‰“é€šï¼Œå†è¿è¡Œk8sã€‚

- åŒä¸€ä¸ªPodå†…çš„å¤šä¸ªå®¹å™¨ä¹‹é—´ï¼šlocalhost
- å„Podä¹‹é—´çš„é€šè®¯ï¼šOverlay Networkï¼Œè¦†ç›–ç½‘ç»œ
- Podä¸Serviceä¹‹é—´çš„é€šè®¯ï¼šå„èŠ‚ç‚¹çš„IPtablesè§„åˆ™ï¼Œæ–°ç‰ˆæœ¬ç”¨LVSäº†ï¼Œæ•ˆç‡æ›´é«˜



**Flannel** æ˜¯CoreOSå›¢é˜Ÿé’ˆå¯¹k8sä½¿å¾—ç½‘ç»œè§„åˆ’æœåŠ¡ï¼Œå®ƒ**æ˜¯è®©é›†ç¾¤ä¸­çš„ä¸åŒèŠ‚ç‚¹ä¸»æœºåˆ›å»ºçš„dockerå®¹å™¨éƒ½å…·æœ‰å…¨é›†ç¾¤å”¯ä¸€çš„è™šæ‹ŸIPåœ°å€**ã€‚è€Œä¸”å®ƒè¿˜èƒ½åœ¨è¿™äº›IPåœ°å€ä¹‹é—´å»ºç«‹ä¸€ä¸ª**è¦†ç›–ç½‘ç»œï¼ˆoverlay networkï¼‰**ï¼Œé€šè¿‡è¿™ä¸ªè¦†ç›–ç½‘ç»œï¼Œå°†æ•°æ®åŒ…åŸå°ä¸åŠ¨åœ°ä¼ é€’åˆ°ç›®æ ‡å®¹å™¨å†…ã€‚

![k8s-flannel.png](./pictures/k8s-flannel.png)

![](./pictures/k8s-flannel2.png)



etcdä¹‹flannelæä¾›è¯´æ˜ï¼š

- å­˜å‚¨ç®¡ç†flannelå¯åˆ†é…çš„IPåœ°å€æ®µèµ„æº
- ç›‘æ§etcdä¸­æ¯ä¸ªpodçš„å®é™…åœ°å€ï¼Œå¹¶åœ¨å†…å­˜ä¸­å»ºç«‹ç»´æŠ¤podèŠ‚ç‚¹è·¯ç”±è¡¨



ä¸åŒç½‘ç»œä¸‹é€šè®¯æ–¹å¼

- åŒä¸€ä¸ªpodå†…éƒ¨é€šä¿¡ï¼šå…±äº«äº†åŒä¸€ä¸ªç½‘ç»œå‘½åç©ºé—´ï¼Œå…±äº«åŒä¸€ä¸ªlinuxåè®®æ ˆ

- pod1è‡³pod2ï¼š
  - ä¸åœ¨åŒä¸€å°ä¸»æœºï¼špodçš„åœ°å€æ˜¯ä¸docker0åœ¨åŒä¸€ä¸ªç½‘æ®µçš„ï¼Œä½†docker0ç½‘æ®µä¸å®¿ä¸»ç½‘å¡æ˜¯ä¸¤ä¸ªä¸åŒçš„IPç½‘æ®µï¼Œå¹¶ä¸”ä¸åŒNodeä¹‹é—´çš„é€šä¿¡åªèƒ½é€šè¿‡å®¿ä¸»æœºçš„ç‰©ç†ç½‘å¡è¿›è¡Œã€‚å°†podçš„IPå’Œæ‰€åœ¨Nodeçš„IPå…³è”èµ·æ¥ï¼Œé€šè¿‡è¿™ä¸ªå…³è”è®©Podå¯ä»¥äº’ç›¸è®¿é—®ã€‚
  - åœ¨åŒä¸€å°ä¸»æœºï¼šç”±docker0ç½‘æ¡¥ç›´æ¥è½¬å‘è¯·æ±‚è‡³pod2ï¼Œä¸éœ€è¦ç»è¿‡ flannel



- podåˆ°serviceçš„ç½‘ç»œï¼šç›®å‰åŸºäºæ€§èƒ½è€ƒè™‘ï¼Œå…¨éƒ¨ä¸ºiptablesç»´æŠ¤å’Œè½¬å‘ï¼›æœ€æ–°ç‰ˆä¸ºlvsã€‚

- podåˆ°å¤–ç½‘ï¼špodå‘å¤–ç½‘å‘é€è¯·æ±‚ï¼ŒæŸ¥æ‰¾è·¯ç”±è¡¨ï¼Œè½¬å‘æ•°æ®åŒ…åˆ°å®¿ä¸»æœºçš„ç½‘å¡ï¼Œå®¿ä¸»ç½‘å¡å®Œæˆè·¯ç”±é€‰æ‹©åï¼Œiptablesæ‰§è¡Œmasqueradeï¼ˆä¼ªè£…ï¼Œæ©è—ï¼‰ï¼ŒæŠŠæºIPæ›´æ”¹ä¸ºå®¿ä¸»ç½‘å¡çš„IPï¼Œç„¶åå‘å¤–ç½‘æœåŠ¡å™¨å‘é€è¯·æ±‚ã€‚

- å¤–ç½‘è®¿é—®Podï¼šService

![image-20210131105805441](./pictures/k8s-network.png)



## minikube

```bash
minikube start --vm-driver=virtualbox --image-mirror-country=cn --image-repository=registry.cn-hangzhou.aliyuncs.com/google_containers --iso-url=https://kubernetes.oss-cn-hangzhou.aliyuncs.com/minikube/iso/minikube-v1.7.3.iso --registry-mirror=https://reg-mirror.qiniu.com
```







## å­˜å‚¨

configMap: ä¸“é—¨ç”¨äºå­˜å‚¨é…ç½®æ–‡ä»¶

Secretï¼šå­˜å‚¨ä¸€äº›æ¯”è¾ƒé‡è¦çš„æ•°æ®ï¼Œæ¯”å¦‚ç”¨æˆ·åå¯†ç ï¼Œéœ€è¦åŠ å¯†çš„

volumeï¼šå­˜ä¸€äº›åŸºæœ¬çš„æ•°æ®ï¼Œæ¯”å¦‚ç½‘é¡µæ–‡ä»¶

PVï¼šæ˜¯åŠ¨æ€çš„è°ƒç”¨è¿‡ç¨‹

å®é™…ç”Ÿäº§ä¸­ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©ä¸åŒçš„å­˜å‚¨æ–¹å¼ã€‚



## è°ƒåº¦å™¨

k8sä¼šè‡ªåŠ¨è°ƒç”¨å®¹å™¨å’Œpodè°ƒåº¦åˆ°å¯¹åº”çš„èŠ‚ç‚¹ï¼

ä¹Ÿèƒ½å®ç°æŠŠpodå®šä¹‰åˆ°æƒ³è¦çš„èŠ‚ç‚¹è¿è¡Œï¼



## é›†ç¾¤å®‰å…¨

é›†ç¾¤çš„è®¤è¯ã€é‰´æƒã€è®¿é—®æ§åˆ¶ã€‚éœ€è¦åå¤æ¸©æ•…çŸ¥æ–°ï¼



## HELM

ç›¸å½“äºlinuxä¸­çš„yumå®‰è£…åŒ…ç®¡ç†å™¨



## è¿ç»´

CICDæ„å»º With Jenkins

kubeadmæºç ä¿®æ”¹ï¼šç›®çš„æ˜¯ä¿®æ”¹é»˜è®¤1å¹´çš„è¯ä¹¦é™åˆ¶

k8sé«˜å¯ç”¨æ„å»º



## kubectl å¸¸ç”¨å‘½ä»¤

```bash
# kubectlæŸ¥çœ‹pod
kubectl get pod -n default -o wide

# kubectlæŸ¥çœ‹podæ—¥å¿—
kubectl -n default log -f tomcat-6bfcb9b549-fs2zt

# kubectlè¿›å…¥åˆ°podå®¹å™¨å†…
kubectl -n default exec -it tocat-imageid

# kubectlæŸ¥çœ‹service
kubectl get svr -n default -o wide

# kubectlæŸ¥çœ‹deployment
kubectl get deployment -n default -o wide

# kubectlæŸ¥çœ‹node
kubectl get node

# kubectlæŸ¥çœ‹èµ„æºæ–‡ä»¶å†…å®¹
kubectl get ing tomcat n default -o json

# kubectlåˆ›å»ºå‘½åç©ºé—´
kubectl create namespace dev

# kubectlé€šè¿‡ymlæ–‡ä»¶åˆ›å»ºèµ„æºå¯¹è±¡
kubectl create -f tomecat-deployment.yml --namespace=default
```



## å‚è€ƒèµ„æ–™

- [kubectl å¸¸ç”¨å‘½ä»¤](https://jingyan.baidu.com/article/d8072ac4087cbdac94cefd5c.html)

- [Kubernetesæ•™ç¨‹(K8så…¥é—¨åˆ°ç²¾é€š)](https://www.bilibili.com/video/BV1w4411y7Go?p=3&spm_id_from=pageDriver)

